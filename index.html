<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookshelves Cooker</title>
    <style>
        :root {
            --theme-color: #ffffff; 
            --accent-color: #1d1d1f;
            --hover-bg: rgba(0, 0, 0, 0.05);
        }

        * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center; background: transparent; }

        .window {
            width: 100%; max-width: 400px; background: #fff; border-radius: 22px;
            box-shadow: 0 15px 45px rgba(0,0,0,0.1); overflow: hidden;
            border: 0.5px solid rgba(0,0,0,0.1); display: flex; flex-direction: column;
        }

        .title-bar {
            height: 54px; background: var(--theme-color);
            display: flex; align-items: center; padding: 0 18px;
            border-bottom: 0.5px solid rgba(0,0,0,0.05); transition: background 0.3s;
        }

        /* ğŸ¨ ìš”ì²­í•˜ì‹  ì»¤ìŠ¤í…€ ì‹ í˜¸ë“± ìƒ‰ìƒ ì ìš© */
        .dots { display: flex; gap: 8px; flex: 1; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot.red { background: #e8bcbc; border: 0.5px solid rgba(0,0,0,0.05); }
        .dot.yellow { background: #f4f4bd; border: 0.5px solid rgba(0,0,0,0.05); }
        .dot.green { background: #c5e8c5; border: 0.5px solid rgba(0,0,0,0.05); }
        
        /* ìœ„ì ¯ ëª¨ë“œ ì „í™˜ ì‹œ ì‹ í˜¸ë“± ìŠ¤íƒ€ì¼ */
        .is-widget .dot { background: rgba(255,255,255,0.5); border: none; }

        .bar-title { font-size: 13px; font-weight: 700; color: #1d1d1f; flex: 2; text-align: center; }

        .nav-controls { flex: 1; display: flex; justify-content: flex-end; gap: 8px; }
        .icon-btn {
            background: none; border: none; cursor: pointer; padding: 5px;
            display: flex; align-items: center; color: #1d1d1f; transition: 0.2s;
        }
        .icon-btn:disabled { opacity: 0.2; }

        .content { padding: 35px 30px; min-height: 360px; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

        h1 { font-size: 22px; font-weight: 800; margin-bottom: 8px; letter-spacing: -0.5px; }
        p { font-size: 13px; color: #86868b; line-height: 1.5; margin-bottom: 25px; }
        
        input, select {
            width: 100%; padding: 14px; border-radius: 12px;
            border: 1px solid #efefef; background: #fbfbfd; outline: none;
            font-size: 14px; margin-bottom: 12px;
        }

        .color-palette { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .color-dot { aspect-ratio: 1; border-radius: 50%; cursor: pointer; border: 2px solid #fff; box-shadow: 0 0 0 1px #eee; }
        .color-dot.active { box-shadow: 0 0 0 2px #1d1d1f; }

        /* ìœ„ì ¯ ê²€ìƒ‰ UI */
        .search-box { padding: 15px; background: #f5f5f7; display: flex; gap: 8px; }
        .input-wrap { flex: 1; background: #fff; border-radius: 12px; border: 1px solid #e5e5e7; display: flex; padding: 0 12px; }
        .input-wrap input { border: none; background: none; margin: 0; flex: 1; }
        
        .results { height: 380px; overflow-y: auto; padding: 10px; }
        .book-item { display: flex; gap: 14px; padding: 12px; border-radius: 16px; cursor: pointer; transition: 0.2s; }
        .book-item:hover { background: var(--hover-bg); }

        .cover { width: 54px; height: 78px; border-radius: 6px; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .book-title { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
        .book-author { font-size: 12px; color: #86868b; }

        #toast {
            position: fixed; bottom: -60px; left: 50%; transform: translateX(-50%);
            background: #1d1d1f; color: #fff; padding: 12px 24px;
            border-radius: 30px; font-size: 13px; transition: 0.5s cubic-bezier(0.2, 1, 0.2, 1);
        }
        #toast.show { bottom: 30px; }
    </style>
</head>
<body>

<div class="window" id="app">
    <div class="title-bar" id="bar">
        <div class="dots"><div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div></div>
        <div class="bar-title">Bookshelves Cooker</div>
        <div class="nav-controls" id="nav">
            <button class="icon-btn" id="prev" onclick="move(-1)" disabled><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg></button>
            <button class="icon-btn" id="next" onclick="move(1)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg></button>
        </div>
    </div>

    <div class="content" id="setup">
        <div class="step active" id="s1">
            <h1>Connect Notion</h1>
            <p>í”„ë¼ì´ë¹— í†µí•© í† í°ì„ ì…ë ¥í•˜ì—¬<br>ì•„ì¹´ì´ë¹™ í˜ì´ì§€ì™€ ì—°ë™í•˜ì„¸ìš”.</p>
            <input type="password" id="tk" placeholder="secret_...">
            <div style="margin-top: 8px;">
                <a href="https://www.notion.so/my-integrations" target="_blank" 
                   style="font-size: 12px; color: #86868b; text-decoration: none; display: inline-flex; align-items: center; gap: 4px;">
                    ë‚´ ì¸í…Œê·¸ë ˆì´ì…˜ ë°”ë¡œê°€ê¸°
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>
                </a>
            </div>
        </div>
        <div class="step" id="s2">
            <h1>Select Library</h1>
            <p>ì±…ì„ ì €ì¥í•  ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
            <select id="db"></select>
        </div>
        <div class="step" id="s3">
            <h1>Design & API</h1>
            <p>ì•Œë¼ë”˜ TTB í‚¤ì™€ í¬ì¸íŠ¸ ìƒ‰ìƒì„ ê³ ë¥´ì„¸ìš”.</p>
            <input type="text" id="ttb" placeholder="ttb key...">
            <div class="color-palette" id="palette"></div>
        </div>
    </div>

    <div id="widget" style="display:none;">
        <div class="search-box">
            <div class="input-wrap">
                <input type="text" id="q" placeholder="ë„ì„œ ì œëª© ê²€ìƒ‰..." onkeypress="if(event.key==='Enter')search()">
                <button class="icon-btn" onclick="search()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></button>
            </div>
        </div>
        <div class="results" id="res"></div>
    </div>
</div>
<div id="toast">Saved! ğŸ¤</div>

<script>
    const SERVER = "https://bookshelves-server.onrender.com";
    let step = 1, selColor = "";
    const themes = ["f7cbd6", "fcd4b8", "fceeb8", "b4e4b4", "a4c4e4", "c8b4c8", "cccccc", "1d1d1f"];

    const params = new URLSearchParams(window.location.search);
    if (params.get('t')) {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('nav').style.display = 'none';
        document.getElementById('widget').style.display = 'block';
        document.getElementById('app').classList.add('is-widget');
        const c = params.get('c');
        if(c) {
            document.documentElement.style.setProperty('--theme-color', '#' + c);
            const r = parseInt(c.slice(0,2),16), g = parseInt(c.slice(2,4),16), b = parseInt(c.slice(4,6),16);
            document.documentElement.style.setProperty('--hover-bg', `rgba(${r},${g},${b},0.15)`);
        }
    } else {
        const pal = document.getElementById('palette');
        themes.forEach(t => {
            const d = document.createElement('div');
            d.className = 'color-dot'; d.style.background = '#' + t;
            d.onclick = () => {
                selColor = t;
                document.querySelectorAll('.color-dot').forEach(el => el.classList.remove('active'));
                d.classList.add('active');
            };
            pal.appendChild(d);
        });
    }

    async function move(n) {
        if (n === 1 && step === 1) {
            const r = await fetch(`${SERVER}/api/notion/databases`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ token: document.getElementById('tk').value })
            });
            const dbs = await r.json();
            document.getElementById('db').innerHTML = dbs.map(d => `<option value="${d.id}">${d.title}</option>`).join('');
        }
        if (step + n === 4) {
            const url = `${window.location.origin}${window.location.pathname}?t=${btoa(document.getElementById('tk').value)}&d=${btoa(document.getElementById('db').value)}&k=${btoa(document.getElementById('ttb').value)}&c=${selColor}`;
            navigator.clipboard.writeText(url);
            return alert("URL ë³µì‚¬ ì™„ë£Œ! ë…¸ì…˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.");
        }
        document.getElementById('s'+step).classList.remove('active');
        step += n;
        document.getElementById('s'+step).classList.add('active');
        document.getElementById('prev').disabled = (step === 1);
    }

    async function search() {
        const res = await fetch(`${SERVER}/api/search?k=${atob(params.get('k'))}&q=${encodeURIComponent(document.getElementById('q').value)}`);
        const books = await res.json();
        document.getElementById('res').innerHTML = books.map(b => `
            <div class="book-item" onclick="save('${b.title}', '${b.author}', '${b.cover}')">
                <img src="${b.cover}" class="cover">
                <div><div class="book-title">${b.title}</div><div class="book-author">${b.author}</div></div>
            </div>
        `).join('');
    }

    async function save(title, author, cover) {
        await fetch(`${SERVER}/api/notion/save`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ token: atob(params.get('t')), db: atob(params.get('d')), title, author, cover })
        });
        const t = document.getElementById('toast');
        t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000);
    }
</script>
</body>
</html>
