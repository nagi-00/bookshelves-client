<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookshelves</title>
    <style>
        :root {
            /* ê¸°ë³¸ê°’: ë½€ëª¨ë„ë¡œ ì¿ ì»¤ì˜ ë¬´ì±„ìƒ‰ ìŠ¤íƒ€ì¼ */
            --theme-color: #ffffff; 
            --accent-color: #1d1d1f;
            --hover-color: rgba(0, 0, 0, 0.05);
            --gray-bg: #f5f5f7;
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { 
            margin: 0; min-height: 100vh; 
            display: flex; align-items: center; justify-content: center; 
            background: transparent; /* ë…¸ì…˜ ì„ë² ë“œ ëŒ€ë¹„ */
        }

        /* macOS ìœˆë„ìš° í”„ë ˆì„ */
        .window {
            width: 100%; max-width: 420px;
            background: #ffffff; border-radius: 22px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.12);
            overflow: hidden; display: flex; flex-direction: column;
            border: 0.5px solid rgba(0,0,0,0.1);
        }

        /* ìƒë‹¨ë°”: ì˜¨ë³´ë”© ì‹œ í°ìƒ‰, ìœ„ì ¯ ì‹œ í…Œë§ˆìƒ‰ */
        .title-bar {
            height: 52px; background: var(--theme-color);
            display: flex; align-items: center; padding: 0 18px;
            border-bottom: 0.5px solid rgba(0,0,0,0.05);
        }

        .dots { display: flex; gap: 7px; flex: 1; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: #e5e5e7; } /* ì˜¨ë³´ë”© ê¸°ë³¸ ì‹ í˜¸ë“± */
        
        /* ìœ„ì ¯ ëª¨ë“œì—ì„œ í…Œë§ˆìƒ‰ì´ ì ìš©ë  ë•Œì˜ ì‹ í˜¸ë“± */
        .window.is-widget .dot { background: rgba(255,255,255,0.5); }

        .bar-title { font-size: 14px; font-weight: 700; color: #1d1d1f; text-align: center; }

        .nav-controls { flex: 1; display: flex; justify-content: flex-end; gap: 8px; }
        .nav-btn {
            background: none; border: 1.5px solid rgba(0,0,0,0.1);
            border-radius: 50%; width: 28px; height: 28px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            color: #1d1d1f;
        }
        .nav-btn:disabled { opacity: 0.2; }
        .nav-btn svg { width: 14px; height: 14px; }

        /* ì»¨í…ì¸  ì˜ì—­ */
        .content { padding: 25px; min-height: 300px; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h1 { font-size: 20px; font-weight: 800; margin-bottom: 8px; letter-spacing: -0.5px; }
        p { font-size: 13px; color: #86868b; margin-bottom: 20px; }
        
        input, select {
            width: 100%; padding: 12px; border-radius: 12px;
            border: 1px solid #efefef; background: #fbfbfd; outline: none; margin-bottom: 10px;
        }

        /* ìœ„ì ¯ ê²€ìƒ‰ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
        .search-area { padding: 15px; background: var(--gray-bg); display: flex; gap: 8px; }
        .search-box { 
            flex: 1; background: #fff; border-radius: 12px; 
            border: 1px solid #e5e5e7; display: flex; align-items: center; padding: 0 10px;
        }
        .search-box input { margin-bottom: 0; border: none; background: none; }
        
        /* ë‹ë³´ê¸° ë²„íŠ¼ (í…Œë§ˆìƒ‰ ë°˜ì˜ ìš”ì†Œ) */
        .search-icon-btn { color: var(--accent-color); background: none; border: none; cursor: pointer; display: flex; }

        .results { height: 350px; overflow-y: auto; padding: 10px; }
        .book-item { 
            display: flex; gap: 12px; padding: 12px; border-radius: 14px; 
            cursor: pointer; transition: 0.2s; 
        }
        /* ë§ˆìš°ìŠ¤ í˜¸ë²„ ì‹œ í…Œë§ˆìƒ‰ ì˜…ê²Œ ë“œë¦¬ìš°ê¸° */
        .book-item:hover { background: var(--hover-color); }

        .cover { width: 50px; height: 72px; border-radius: 5px; object-fit: cover; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .title { font-size: 14px; font-weight: 600; margin-bottom: 3px; }
        .author { font-size: 12px; color: #86868b; }

        /* Saved! ì•Œë¦¼ */
        #toast {
            position: fixed; bottom: -50px; left: 50%; transform: translateX(-50%);
            background: #1d1d1f; color: #fff; padding: 10px 22px;
            border-radius: 25px; font-size: 13px; transition: 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        #toast.show { bottom: 30px; }
    </style>
</head>
<body>

<div class="window" id="windowFrame">
    <div class="title-bar" id="titleBar">
        <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        <div class="bar-title">Bookshelves</div>
        <div class="nav-controls" id="navControls">
            <button class="nav-btn" id="prevBtn" onclick="moveStep(-1)" disabled>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <button class="nav-btn" id="nextBtn" onclick="moveStep(1)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M9 18l6-6-6-6"/></svg>
            </button>
        </div>
    </div>

    <div class="content" id="onboardingContent">
        <div class="step active" id="step1">
            <h1>Notion Connect</h1>
            <p>í†µí•© í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="password" id="notionToken" placeholder="secret_...">
        </div>
        <div class="step" id="step2">
            <h1>Select Library</h1>
            <p>ì±…ì„ ì €ì¥í•  DBë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
            <select id="dbSelect"></select>
        </div>
        <div class="step" id="step3">
            <h1>Aladin API</h1>
            <p>TTB í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="text" id="ttbKey" placeholder="ttb...">
        </div>
        <div class="step" id="step4">
            <h1>Theme Color</h1>
            <p>í¬ì¸íŠ¸ ìƒ‰ìƒì„ ì„ íƒí•˜ì„¸ìš”.</p>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;" id="colorPalette"></div>
        </div>
    </div>

    <div id="widgetContent" style="display: none;">
        <div class="search-area">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ì œëª© ì…ë ¥ í›„ Enter" onkeypress="if(event.key==='Enter')performSearch()">
                <button class="search-icon-btn" onclick="performSearch()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                </button>
            </div>
        </div>
        <div class="results" id="bookList"></div>
    </div>
</div>

<div id="toast">Saved! ğŸ¤</div>

<script>
    const SERVER_URL = "https://bookshelves-server.onrender.com";
    let currentStep = 1;
    let selectedColor = "";

    // 1. ì´ˆê¸° ëª¨ë“œ íŒë³„
    const params = new URLSearchParams(window.location.search);
    if (params.get('t')) {
        initWidgetMode();
    } else {
        initOnboardingMode();
    }

    // --- ìœ„ì ¯ ëª¨ë“œ ---
    function initWidgetMode() {
        document.getElementById('onboardingContent').style.display = 'none';
        document.getElementById('navControls').style.display = 'none';
        document.getElementById('widgetContent').style.display = 'block';
        document.getElementById('windowFrame').classList.add('is-widget');

        const bg = params.get('color');
        if (bg) {
            const r = parseInt(bg.substring(0,2), 16), g = parseInt(bg.substring(2,4), 16), b = parseInt(bg.substring(4,6), 16);
            document.documentElement.style.setProperty('--theme-color', '#' + bg);
            document.documentElement.style.setProperty('--accent-color', '#1d1d1f'); // ë‹ë³´ê¸° ìƒ‰ìƒ
            document.documentElement.style.setProperty('--hover-color', `rgba(${r}, ${g}, ${b}, 0.15)`);
        }
    }

    async function performSearch() {
        const q = document.getElementById('searchInput').value;
        const list = document.getElementById('bookList');
        list.innerHTML = '<p style="text-align:center; margin-top:50px; font-size:12px;">Searching...</p>';
        
        const res = await fetch(`${SERVER_URL}/api/search?k=${atob(params.get('k'))}&q=${encodeURIComponent(q)}`);
        const books = await res.json();
        
        list.innerHTML = books.map(b => `
            <div class="book-item" onclick="saveToNotion('${b.title}', '${b.author}', '${b.cover}')">
                <img src="${b.cover}" class="cover">
                <div class="info">
                    <div class="title">${b.title}</div>
                    <div class="author">${b.author}</div>
                </div>
            </div>
        `).join('');
    }

    async function saveToNotion(title, author, cover) {
        await fetch(`${SERVER_URL}/api/notion/save`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                token: atob(params.get('t')),
                db: atob(params.get('d')),
                title, author, cover
            })
        });
        const toast = document.getElementById('toast');
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // --- ì˜¨ë³´ë”© ëª¨ë“œ ---
    function initOnboardingMode() {
        const palette = document.getElementById('colorPalette');
        const colors = ["f7cbd6", "fcd4b8", "fceeb8", "b4e4b4", "a4c4e4", "c8b4c8", "cccccc"];
        colors.forEach(c => {
            const d = document.createElement('div');
            d.style.cssText = `aspect-ratio:1; border-radius:50%; background:#${c}; cursor:pointer; border:2px solid #fff; box-shadow:0 0 0 1px #eee;`;
            d.onclick = () => {
                selectedColor = c;
                document.querySelectorAll('#colorPalette div').forEach(el => el.style.boxShadow = '0 0 0 1px #eee');
                d.style.boxShadow = '0 0 0 2px #1d1d1f';
            };
            palette.appendChild(d);
        });
    }

    async function moveStep(n) {
        if (n === 1 && currentStep === 1) {
            const token = document.getElementById('notionToken').value;
            const res = await fetch(`${SERVER_URL}/api/notion/databases`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ token })
            });
            const dbs = await res.json();
            document.getElementById('dbSelect').innerHTML = dbs.map(d => `<option value="${d.id}">${d.title}</option>`).join('');
        }
        
        if (currentStep + n === 5) return finishOnboarding();

        document.getElementById(`step${currentStep}`).classList.remove('active');
        currentStep += n;
        document.getElementById(`step${currentStep}`).classList.add('active');
        document.getElementById('prevBtn').disabled = (currentStep === 1);
    }

    function finishOnboarding() {
        const t = btoa(document.getElementById('notionToken').value);
        const d = btoa(document.getElementById('dbSelect').value);
        const k = btoa(document.getElementById('ttbKey').value);
        const url = `${window.location.origin}${window.location.pathname}?t=${t}&d=${d}&k=${k}&color=${selectedColor}`;
        navigator.clipboard.writeText(url);
        alert("ìœ„ì ¯ URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ë…¸ì…˜ì— ì„ë² ë“œí•˜ì„¸ìš”.");
    }
</script>
</body>
</html>
