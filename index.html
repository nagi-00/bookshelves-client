<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookshelves | Connect</title>
    <style>
        :root {
            --mac-bg: #f5f5f7;
            --mac-card: #ffffff;
            --accent: #007aff;
            --gray-text: #86868b;
            --dot-red: #f3aeaf;
            --dot-yellow: #f7e3af;
            --dot-green: #b1d9b7;
        }

        body {
            margin: 0; background: var(--mac-bg);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .window {
            width: 440px; background: var(--mac-card); border-radius: 18px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.12); overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05); position: relative;
        }

        /* [ìƒë‹¨ë°”] ì‚¬ì§„ê³¼ 100% ë™ì¼í•œ ë°°ì¹˜ ë° ì»¬ëŸ¬ */
        .title-bar {
            height: 48px; background: #ffffff; display: flex; align-items: center;
            padding: 0 20px; border-bottom: 0.5px solid #efefef;
        }
        .dots { display: flex; gap: 8px; width: 80px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot.red { background: var(--dot-red); } 
        .dot.yellow { background: var(--dot-yellow); } 
        .dot.green { background: var(--dot-green); }
        
        .bar-title { flex: 1; text-align: center; font-size: 14px; font-weight: 600; color: #1d1d1f; }

        .nav-controls { display: flex; gap: 15px; width: 80px; justify-content: flex-end; align-items: center; }
        .nav-btn {
            background: none; border: none; font-size: 18px; cursor: pointer;
            color: #d2d2d7; transition: color 0.2s; padding: 0; line-height: 1;
        }
        .nav-btn.active { color: #1d1d1f; } /* í™”ì‚´í‘œ í‘ë°± */
        .check-icon { font-size: 20px; color: #1d1d1f; text-decoration: none; display: none; }

        /* ì»¨í…ì¸  ì˜ì—­ */
        .step-container { padding: 45px; min-height: 350px; display: none; }
        .step-container.active { display: block; animation: fadeIn 0.4s ease; }

        h1 { font-size: 24px; font-weight: 700; margin: 0 0 12px 0; letter-spacing: -0.8px; }
        p.desc { font-size: 14px; color: var(--gray-text); margin-bottom: 32px; line-height: 1.5; }
        .sub-desc { font-size: 13px; color: #d2d2d7; margin-bottom: 20px; margin-top: -25px; }
        
        .input-group { margin-bottom: 24px; }
        label { display: block; font-size: 11px; font-weight: 700; color: var(--gray-text); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select {
            width: 100%; padding: 14px 16px; border-radius: 12px; border: 1.5px solid #efefef;
            background: #fbfbfd; font-size: 15px; outline: none; box-sizing: border-box; transition: 0.2s;
        }
        input:focus { border-color: #1d1d1f; background: #fff; }

        /* [Step 4] ë””ìì¸ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
        .color-palette { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 30px; }
        .color-item { text-align: center; width: 45px; cursor: pointer; }
        .color-circle { 
            width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 8px; 
            border: 2px solid transparent; position: relative; transition: 0.2s;
        }
        .color-circle.selected { border-color: #1d1d1f; }
        .color-circle.selected::after { content: 'âœ“'; color: #fff; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; }
        .color-name { font-size: 11px; color: var(--gray-text); }

        .custom-slider { margin-bottom: 25px; background: #f5f5f7; padding: 20px; border-radius: 15px; }
        .slider-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 10px; font-weight: 600; }
        input[type="color"] { border: none; padding: 0; width: 100%; height: 40px; border-radius: 10px; cursor: pointer; background: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="window">
    <div class="title-bar">
        <div class="dots">
            <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
        </div>
        <div class="bar-title">Bookshelves</div>
        <div class="nav-controls">
            <button class="nav-btn" id="prevBtn" onclick="moveStep(-1)">â†</button>
            <button class="nav-btn active" id="nextBtn" onclick="moveStep(1)">â†’</button>
            <button class="nav-btn" id="finishBtn" onclick="finish()" style="display:none;">âœ“</button>
        </div>
    </div>

    <div class="step-container active" id="step1">
        <h1>Connect Notion</h1>
        <p class="desc">â˜… ìš°ì„  API í† í°ì„ ë°œê¸‰ë°›ê³ , ì•„ì¹´ì´ë¹™ì— ì‚¬ìš©í•˜ëŠ” í˜ì´ì§€ì™€ ì—°ë™í•´ì£¼ì„¸ìš”.</p>
        <div class="input-group">
            <label>Internal Integration Token</label>
            <input type="password" id="notion-token" placeholder="secret_xxxxxxx">
            <a href="https://www.notion.so/profile/integrations" target="_blank" style="font-size:12px; color:var(--accent); text-decoration:none; display:inline-block; margin-top:8px;">ë‚´ ì¸í‹°ê·¸ë ˆì´ì…˜ ë°”ë¡œê°€ê¸° â†—</a>
        </div>
    </div>

    <div class="step-container" id="step2">
        <h1>Select Library</h1>
        <p class="sub-desc">Select your Database.</p>
        <p class="desc">ë„ì„œë¥¼ ì €ì¥í•  ë°ì´í„°ë² ì´ìŠ¤(BOOK DB)ë¥¼ ëª©ë¡ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        <div class="input-group">
            <label>Available Databases</label>
            <select id="db-select"><option value="">Loading...</option></select>
        </div>
    </div>

    <div class="step-container" id="step3">
        <h1>Personalize</h1>
        <p class="sub-desc">Insert your personal TTB key.</p>
        <div class="input-group">
            <label>Aladin TTB Key</label>
            <input type="text" id="ttb-key" placeholder="ttbxxxxxxx">
        </div>
    </div>

    <div class="step-container" id="step4">
        <h1>Widget Design</h1>
        <p class="desc">ìœ„ì ¯ì˜ ì»¬ëŸ¬ì™€ í…Œë§ˆë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì§• í•˜ì„¸ìš”.</p>
        
        <label>COLOR SAMPLES</label>
        <div class="color-palette">
            <div class="color-item" onclick="pickColor('#f7cbd6')"><div class="color-circle selected" style="background:#f7cbd6;"></div><div class="color-name">Pink</div></div>
            <div class="color-item" onclick="pickColor('#f9d5bb')"><div class="color-circle" style="background:#f9d5bb;"></div><div class="color-name">Coral</div></div>
            <div class="color-item" onclick="pickColor('#ffffff')"><div class="color-circle" style="background:#ffffff; border:1px solid #eee;"></div><div class="color-name">White</div></div>
            <div class="color-item" onclick="pickColor('#f6e8b1')"><div class="color-circle" style="background:#f6e8b1;"></div><div class="color-name">Yellow</div></div>
            <div class="color-item" onclick="pickColor('#b4e4c0')"><div class="color-circle" style="background:#b4e4c0;"></div><div class="color-name">Green</div></div>
            <div class="color-item" onclick="pickColor('#aac4f2')"><div class="color-circle" style="background:#aac4f2;"></div><div class="color-name">Blue</div></div>
        </div>

        <div class="custom-slider">
            <div class="slider-header"><span>Primary Color</span><span id="hex-val">#F7CBD6</span></div>
            <input type="color" id="primary-picker" value="#f7cbd6" oninput="updateColor(this.value)">
        </div>
    </div>
</div>

<script>
    const SERVER_URL = "https://bookshelves-server.onrender.com";
    let currentStep = 1;
    let selectedColor = "#f7cbd6";

    async function moveStep(step) {
        const next = currentStep + step;
        if (step === 1) {
            if (currentStep === 1 && !document.getElementById('notion-token').value) return alert('í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            if (currentStep === 1) await loadDatabases(document.getElementById('notion-token').value);
            if (currentStep === 2 && !document.getElementById('db-select').value) return alert('DBë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
            if (currentStep === 3 && !document.getElementById('ttb-key').value) return alert('TTB í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        }

        if (next >= 1 && next <= 4) {
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${next}`).classList.add('active');
            currentStep = next;
            updateNav();
        }
    }

    function updateNav() {
        document.getElementById('prevBtn').classList.toggle('active', currentStep > 1);
        document.getElementById('nextBtn').style.display = currentStep === 4 ? 'none' : 'block';
        document.getElementById('finishBtn').style.display = currentStep === 4 ? 'block' : 'none';
    }

    async function loadDatabases(token) {
        const select = document.getElementById('db-select');
        try {
            const res = await fetch(`${SERVER_URL}/api/notion/databases`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token })
            });
            const dbs = await res.json();
            select.innerHTML = dbs.map(db => `<option value="${db.id}">${db.title}</option>`).join('');
        } catch (e) { alert('ì—°ê²° ì‹¤íŒ¨!'); moveStep(-1); }
    }

    function pickColor(color) {
        selectedColor = color;
        document.querySelectorAll('.color-circle').forEach(el => el.classList.remove('selected'));
        event.currentTarget.querySelector('.color-circle').classList.add('selected');
        document.getElementById('primary-picker').value = color;
        document.getElementById('hex-val').innerText = color.toUpperCase();
    }

    function updateColor(color) {
        selectedColor = color;
        document.getElementById('hex-val').innerText = color.toUpperCase();
        document.querySelectorAll('.color-circle').forEach(el => el.classList.remove('selected'));
    }

    function finish() {
        const t = btoa(document.getElementById('notion-token').value);
        const d = btoa(document.getElementById('db-select').value);
        const k = btoa(document.getElementById('ttb-key').value);
        const bg = selectedColor.replace('#', '');
        const finalUrl = `${SERVER_URL}/widget?t=${t}&d=${d}&k=${k}&bg=${bg}`;
        
        navigator.clipboard.writeText(finalUrl);
        alert('ë³µì‚¬ ì™„ë£Œ! ë…¸ì…˜ì—ì„œ /embed í•´ì£¼ì„¸ìš”. ğŸ¤');
    }
</script>
</body>
</html>
