<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bookshelves Cooker</title>
    <style>
        :root { --theme-color: #ffffff; }
        * { box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
        
        /* ì „ì²´ ë°°ê²½ ë° ì •ë ¬ */
        body { 
            margin: 0; min-height: 100vh; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; background: transparent; padding: 20px;
            overflow-x: hidden;
        }

        /* [í•µì‹¬] ìœ„ì ¯ í¬ê¸° ê°•ì œ ê³ ì • */
        .widget-frame { 
            width: 240px !important; 
            height: 175px !important; 
            min-height: 175px !important;
            max-height: 175px !important;
            background: #fff; border-radius: 18px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.08); 
            overflow: hidden; display: flex; flex-direction: column;
            border: 1px solid rgba(0,0,0,0.05);
            position: relative;
        }

        /* ì˜¨ë³´ë”© ì„¤ì •ì°½ */
        .window { width: 100%; max-width: 400px; background: #fff; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 25px; border: 1px solid #eee; }
        .title-bar { height: 40px; background: #f6f6f6; display: flex; align-items: center; padding: 0 15px; }
        .dots { display: flex; gap: 6px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #ddd; }
        .content { padding: 25px; min-height: 250px; }
        .step { display: none; }
        .step.active { display: block; }
        h1 { font-size: 18px; margin: 0 0 10px; }
        p { font-size: 13px; color: #666; margin-bottom: 15px; }
        input, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; font-size: 13px; }
        button.primary { width: 100%; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; background: #1d1d1f; color: #fff; margin-top: 10px; }

        /* ìœ„ì ¯ ë‚´ë¶€ ë ˆì´ì•„ì›ƒ */
        .widget-top { height: 32px; background: var(--theme-color); display: flex; align-items: center; justify-content: center; border-bottom: 1px solid rgba(0,0,0,0.03); }
        .w-title { font-size: 10px; font-weight: 800; color: #333; opacity: 0.8; }
        
        #widgetHome { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #currentTime { font-size: 34px; font-weight: 800; color: #1d1d1f; letter-spacing: -1px; }
        .search-trigger { margin-top: 8px; padding: 5px 16px; border-radius: 12px; background: rgba(0,0,0,0.04); font-size: 9px; font-weight: 600; border: none; cursor: pointer; color: #666; }

        #widgetSearch { display: none; flex: 1; flex-direction: column; padding: 10px; background: #fff; }
        .search-box { display: flex; gap: 6px; margin-bottom: 8px; }
        .search-box input { margin-bottom: 0; padding: 0 10px; height: 28px; background: #f4f4f7; border: none; flex: 1; }
        .close-btn { width: 28px; height: 28px; border-radius: 6px; border: none; background: #eee; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center; }

        .book-list { flex: 1; overflow-y: auto; overflow-x: hidden; }
        .book-item { display: flex; gap: 10px; padding: 7px; cursor: pointer; border-radius: 8px; align-items: center; transition: background 0.2s; }
        .book-item:hover { background: #f5f5f7; }
        .book-item img { width: 34px; height: 48px; object-fit: cover; border-radius: 4px; background: #f0f0f2; flex-shrink: 0; }
        .book-info { overflow: hidden; }
        .book-info div:first-child { font-size: 10px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .book-info div:last-child { font-size: 8px; color: #999; }

        /* ì„ë² ë“œ ìƒíƒœì¼ ë•Œ ë°°ê²½ ìˆ¨ê¹€ */
        body.is-embed .window { display: none; }
    </style>
</head>
<body>

    <div class="window" id="setupWindow">
        <div class="title-bar"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
        <div class="content">
            <div class="step active" id="step1">
                <h1>Connect Notion</h1>
                <p>í”„ë¼ì´ë¹— API í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
                <input type="password" id="tokenInput" placeholder="secret_...">
                <button class="primary" onclick="moveStep(1)">ë‹¤ìŒìœ¼ë¡œ</button>
            </div>
            <div class="step" id="step2">
                <h1>Select Library</h1>
                <p>ì±…ì„ ì €ì¥í•  ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                <select id="dbSelect"></select>
                <button class="primary" onclick="moveStep(1)">ë‹¤ìŒìœ¼ë¡œ</button>
            </div>
            <div class="step" id="step3">
                <h1>Customize</h1>
                <p>TTB í‚¤ë¥¼ ì…ë ¥í•˜ê³  ìœ„ì ¯ì„ ì™„ì„±í•˜ì„¸ìš”.</p>
                <input type="text" id="ttbInput" placeholder="ì•Œë¼ë”˜ TTB í‚¤">
                <button class="primary" onclick="finishSetup()">ìœ„ì ¯ ìƒì„± ì™„ë£Œ! ë…¸ì…˜ì—ì„œ /embed ì…ë ¥ í›„ ë¶™ì—¬ë„£ì–´ë³´ì„¸ìš”. ğŸ¤</button>
            </div>
        </div>
    </div>

    <div class="widget-frame">
        <div class="widget-top"><div class="w-title">Bookshelves</div></div>
        <div id="widgetHome">
            <div id="currentTime">00:00</div>
            <button class="search-trigger" onclick="showSearch()">Search Book</button>
        </div>
        <div id="widgetSearch">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search..." onkeypress="if(event.key==='Enter')performSearch()">
                <button class="close-btn" onclick="goHome()">âœ•</button>
            </div>
            <div class="book-list" id="resultList"></div>
        </div>
    </div>

<script>
    const SERVER_URL = "https://bookshelves-server.onrender.com"; 
    let step = 1;
    const params = new URLSearchParams(window.location.search);

    function updateClock() {
        const now = new Date();
        document.getElementById('currentTime').innerText = 
            now.getHours().toString().padStart(2, '0') + ":" + 
            now.getMinutes().toString().padStart(2, '0');
    }
    setInterval(updateClock, 1000); updateClock();

    function showSearch() { 
        document.getElementById('widgetHome').style.display='none'; 
        document.getElementById('widgetSearch').style.display='flex'; 
        document.getElementById('searchInput').focus();
    }
    function goHome() { 
        document.getElementById('widgetSearch').style.display='none'; 
        document.getElementById('widgetHome').style.display='flex'; 
    }

    if (params.get('t')) { 
        document.body.classList.add('is-embed'); 
    }

    async function moveStep(n) {
        if (step === 1) {
            const tk = document.getElementById('tokenInput').value;
            try {
                const res = await fetch(`${SERVER_URL}/api/notion/databases`, { 
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ token: tk })
                });
                const dbs = await res.json();
                document.getElementById('dbSelect').innerHTML = dbs.map(d => `<option value="${d.id}">${d.title}</option>`).join('');
            } catch(e) { alert("ì—°ê²° ì‹¤íŒ¨: í† í°ì„ í™•ì¸í•˜ì„¸ìš”."); return; }
        }
        document.getElementById(`step${step}`).classList.remove('active');
        step += n;
        document.getElementById(`step${step}`).classList.add('active');
    }

    function finishSetup() {
        const t = btoa(document.getElementById('tokenInput').value);
        const d = btoa(document.getElementById('dbSelect').value);
        const k = btoa(document.getElementById('ttbInput').value);
        const url = `${window.location.origin}${window.location.pathname}?t=${t}&d=${d}&k=${k}`;
        navigator.clipboard.writeText(url);
        alert("ìœ„ì ¯ URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ë…¸ì…˜ì— ì„ë² ë“œí•˜ì„¸ìš”.");
    }

    async function performSearch() {
        const query = document.getElementById('searchInput').value;
        const ttb = atob(params.get('k'));
        const res = await fetch(`${SERVER_URL}/api/search?k=${ttb}&q=${encodeURIComponent(query)}`);
        const books = await res.json();
        
        document.getElementById('resultList').innerHTML = books.map(b => `
            <div class="book-item" onclick="saveToNotion('${b.title.replace(/'/g,"")}', '${b.author.replace(/'/g,"")}', '${b.cover}', '')">
                <img src="${b.cover}" onerror="this.src='https://via.placeholder.com/150x200?text=No+Image'">
                <div class="book-info">
                    <div>${b.title}</div>
                    <div>${b.author}</div>
                </div>
            </div>
        `).join('');
    }

    async function saveToNotion(title, author, cover, description) {
        try {
            await fetch(`${SERVER_URL}/api/notion/save`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    token: atob(params.get('t')), 
                    db: atob(params.get('d')), 
                    title, author, cover, description 
                })
            });
            alert("ë…¸ì…˜ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ¤");
            goHome();
        } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨"); }
    }
</script>
</body>
</html>
