<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookshelves | Setup</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(180deg, #f5f5f7 0%, #e5e5e7 100%);
            min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem;
        }

        /* macOS Window Frame */
        .window-frame {
            max-width: 480px; width: 100%;
            background: white; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15); overflow: hidden;
        }

        /* Title Bar with User-Selected Theme Color */
        .title-bar {
            background: var(--theme-color, #f7cbd6);
            height: 52px; padding: 0 1rem;
            display: flex; align-items: center; justify-content: space-between;
            transition: background 0.3s ease;
        }

        .window-dots { display: flex; gap: 8px; width: 60px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; background: rgba(255,255,255,0.5); }

        .window-title { font-size: 0.9rem; font-weight: 700; color: #1d1d1f; }

        /* Navigation Buttons (Same as Pomodoro) */
        .nav-controls { display: flex; gap: 8px; width: 60px; justify-content: flex-end; }
        .nav-btn {
            background: none; border: 1.5px solid rgba(29,29,31,0.2);
            border-radius: 50%; width: 28px; height: 28px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            color: #1d1d1f; transition: all 0.2s;
        }
        .nav-btn:hover:not(:disabled) { border-color: #1d1d1f; background: rgba(255,255,255,0.2); }
        .nav-btn:disabled { opacity: 0.2; cursor: default; }
        .nav-btn svg { width: 16px; height: 16px; }

        /* Content Area */
        .content { padding: 2.5rem; min-height: 380px; display: flex; flex-direction: column; }
        .step { display: none; animation: fadeIn 0.4s ease; }
        .step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .step-label { font-size: 0.7rem; font-weight: 700; color: #86868b; text-transform: uppercase; margin-bottom: 0.5rem; display: block; }
        h1 { font-size: 1.6rem; font-weight: 800; color: #1d1d1f; margin-bottom: 1.5rem; letter-spacing: -0.5px; }
        
        input, select {
            width: 100%; padding: 1rem; border-radius: 12px;
            border: 1.5px solid #efefef; background: #fbfbfd;
            font-size: 1rem; outline: none; transition: border-color 0.2s;
            margin-bottom: 1rem;
        }
        input:focus { border-color: #1d1d1f; }

        /* Color Picker Grid */
        .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem; }
        .color-opt {
            aspect-ratio: 1; border-radius: 50%; border: 3px solid white;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s; position: relative;
        }
        .color-opt:hover { transform: scale(1.1); }
        .color-opt.active::after {
            content: 'ğŸ¤'; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); color: #1d1d1f; font-weight: 900;
        }

        /* Toast Message */
        .toast {
            position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #1d1d1f; color: white; padding: 1rem 2rem;
            border-radius: 50px; font-size: 0.9rem; opacity: 0; transition: all 0.4s; z-index: 1000;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div class="window-frame">
        <div class="title-bar" id="titleBar">
            <div class="window-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
            <div class="window-title">Bookshelves Setup</div>
            <div class="nav-controls">
                <button class="nav-btn" id="prevBtn" onclick="moveStep(-1)" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button class="nav-btn" id="nextBtn" onclick="moveStep(1)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
            </div>
        </div>

        <div class="content">
            <div class="step active" id="step1">
                <span class="step-label">Step 1</span>
                <h1>Connect Notion</h1>
                <p style="font-size: 0.9rem; color:#86868b; margin-bottom: 1.5rem;">í”„ë¼ì´ë¹— í†µí•© í† í°ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
                <input type="password" id="notionToken" placeholder="secret_xxxxxxxx..." onkeypress="if(event.key==='Enter')moveStep(1)">
                <a href="https://www.notion.so/my-integrations" target="_blank" style="color:#0066cc; font-size:0.8rem; text-decoration:none;">í† í° ë°œê¸‰ë°›ê¸° â†—</a>
            </div>

            <div class="step" id="step2">
                <span class="step-label">Step 2</span>
                <h1>Select Library</h1>
                <p style="font-size: 0.9rem; color:#86868b; margin-bottom: 1.5rem;">ì±…ì„ ì €ì¥í•  ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                <select id="dbSelect"></select>
            </div>

            <div class="step" id="step3">
                <span class="step-label">Step 3</span>
                <h1>Aladin API</h1>
                <p style="font-size: 0.9rem; color:#86868b; margin-bottom: 1.5rem;">ì•Œë¼ë”˜ TTB í‚¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
                <input type="text" id="ttbKey" placeholder="ttbxxxxxxxx..." onkeypress="if(event.key==='Enter')moveStep(1)">
            </div>

            <div class="step" id="step4">
                <span class="step-label">Step 4</span>
                <h1>Design Theme</h1>
                <p style="font-size: 0.9rem; color:#86868b; margin-bottom: 1rem;">ìœ„ì ¯ ìƒë‹¨ë°”ì™€ í¬ì¸íŠ¸ ìƒ‰ìƒì„ ì„ íƒí•˜ì„¸ìš”.</p>
                <div class="color-grid" id="colorGrid"></div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">ë³µì‚¬ ì™„ë£Œ! ë…¸ì…˜ì— /embed í›„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”. ğŸ¤</div>

    <script>
        let currentStep = 1;
        let selectedColor = "f7cbd6";
        const colors = ["f7cbd6", "fcd4b8", "cccccc", "fceeb8", "b4e4b4", "a4c4e4", "c8b4c8", "ff9999"];
        const SERVER_URL = "https://bookshelves-server.onrender.com"; // ì‹¤ì œ ì„œë²„ URLë¡œ ìˆ˜ì •

        // ì»¬ëŸ¬ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
        const grid = document.getElementById('colorGrid');
        colors.forEach(c => {
            const div = document.createElement('div');
            div.className = `color-opt ${c === selectedColor ? 'active' : ''}`;
            div.style.backgroundColor = '#' + c;
            div.onclick = () => selectColor(c);
            grid.appendChild(div);
        });

        function selectColor(c) {
            selectedColor = c;
            document.querySelectorAll('.color-opt').forEach(opt => opt.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('titleBar').style.backgroundColor = '#' + c;
        }

        async function moveStep(n) {
            // Step 1 -> 2ë¡œ ë„˜ì–´ê°ˆ ë•Œ DB ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            if (n === 1 && currentStep === 1) {
                const token = document.getElementById('notionToken').value;
                if(!token) return alert("í† í°ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
                
                document.getElementById('nextBtn').disabled = true;
                try {
                    const res = await fetch(`${SERVER_URL}/api/notion/databases`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ token })
                    });
                    const dbs = await res.json();
                    
                    let html = "";
                    dbs.forEach(db => {
                        // DB ì œëª©ì´ ì œëŒ€ë¡œ ë¶ˆëŸ¬ì™€ì§€ì§€ ì•Šë˜ ë¬¸ì œ í•´ê²°
                        html += `<option value="${db.id}">${db.title || 'ì œëª© ì—†ìŒ'}</option>`;
                    });
                    document.getElementById('dbSelect').innerHTML = html;
                } catch (e) {
                    return alert("DBë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í† í°ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                } finally {
                    document.getElementById('nextBtn').disabled = false;
                }
            }

            // ë§ˆì§€ë§‰ ë‹¨ê³„ì—ì„œ 'ë‹¤ìŒ' ëˆ„ë¥´ë©´ ì™„ë£Œ
            if (n === 1 && currentStep === 4) return finishSetup();

            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep += n;
            document.getElementById(`step${currentStep}`).classList.add('active');

            document.getElementById('prevBtn').disabled = (currentStep === 1);
            document.getElementById('nextBtn').innerHTML = (currentStep === 4) ? 
                `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg>` : 
                `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
        }

        function finishSetup() {
            const params = new URLSearchParams({
                t: btoa(document.getElementById('notionToken').value),
                d: btoa(document.getElementById('dbSelect').value),
                k: btoa(document.getElementById('ttbKey').value),
                color: selectedColor
            });

            const finalUrl = `${SERVER_URL}/widget?${params.toString()}`;
            
            navigator.clipboard.writeText(finalUrl).then(() => {
                const toast = document.getElementById('toast');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            });
        }
    </script>
</body>
</html>
